<div class="w-full max-w-6xl mx-auto space-y-6">
  <!-- Encabezado -->
  <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
    <div>
      <p class="text-xs font-semibold uppercase tracking-[0.25em] text-primary">
        Feedback
      </p>
      <h1 class="mt-1 text-2xl sm:text-3xl font-bold leading-tight break-words">
        Evalúa tus recomendaciones
      </h1>
      <p class="mt-2 text-sm text-text-muted max-w-xl">
        Selecciona una de tus últimas recomendaciones y cuéntanos qué tan útil fue.
        Esto nos ayuda a medir si las sugerencias realmente están ayudando a prevenir molestias y lesiones.
      </p>
    </div>
  </div>

  <!-- Mensajes -->
  <div
    *ngIf="error"
    class="text-xs text-danger bg-danger/10 border border-danger/40 rounded-xl px-3 py-2"
  >
    {{ error }}
  </div>
  <div
    *ngIf="submitMessage"
    class="text-xs text-accent bg-accent/10 border border-accent/40 rounded-xl px-3 py-2"
  >
    {{ submitMessage }}
  </div>

  <!-- Contenido principal: dos tarjetas -->
  <div class="grid gap-4 md:grid-cols-2">
    <!-- Columna izquierda: últimas recomendaciones -->
    <div class="bg-app-card border border-app-border rounded-2xl p-4 sm:p-5 space-y-3">
      <h2 class="text-sm font-semibold">Últimas recomendaciones</h2>
      <p class="text-xs text-text-muted">
        Selecciona una recomendación reciente para evaluarla.
      </p>

      <ng-container *ngIf="!loading && recommendations.length; else noRecs">
        <ul class="space-y-1.5 text-xs">
          <li
            *ngFor="let rec of recommendations"
            class="flex items-start gap-2"
          >
            <button
              type="button"
              (click)="selectRecommendation(rec)"
              class="flex-1 text-left px-3 py-2 rounded-xl border text-[11px] transition
                     flex items-start justify-between gap-2"
              [ngClass]="
                selectedRecommendation?.id === rec.id
                  ? 'border-primary bg-primary/10 text-text-main'
                  : 'border-app-border bg-slate-950/40 text-text-muted hover:border-primary/60 hover:text-text-main'
              "
            >
              <div>
                <p class="font-medium text-xs">
                  {{ rec.tipo }}
                </p>
                <p class="text-[11px] truncate max-w-xs">
                  {{ rec.descripcion }}
                </p>
                <p class="text-[10px] text-text-muted/80 mt-0.5">
                  {{ rec.fechaTexto }} · {{ rec.fuente }}
                </p>
              </div>
              <span
                class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[10px]"
                [ngClass]="getRiskPillClasses(rec.riskLevel)"
              >
                <span
                  class="h-1.5 w-1.5 rounded-full"
                  [ngClass]="getRiskDotClasses(rec.riskLevel)"
                ></span>
                {{ rec.riskLevel | titlecase }}
              </span>
            </button>
          </li>
        </ul>
      </ng-container>

      <ng-template #noRecs>
        <div
          class="text-xs text-text-muted bg-slate-950/40 border border-dashed border-app-border rounded-xl px-3 py-3"
        >
          Aún no tienes recomendaciones registradas o no se pudieron cargar.
          Genera una recomendación desde la sección
          <span class="font-medium">Recomendación</span> para poder evaluarla.
        </div>
      </ng-template>
    </div>

    <!-- Columna derecha: formulario de evaluación -->
    <div class="bg-app-card border border-app-border rounded-2xl p-4 sm:p-5 space-y-4">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h2 class="text-sm font-semibold">Evalúa tu recomendación</h2>
          <p class="text-xs text-text-muted">
            Recomendación:
            <span class="font-medium text-text-main">
              {{ selectedRecommendation?.tipo || 'Selecciona una recomendación de la lista' }}
            </span>
          </p>
        </div>
      </div>

      <!-- FORMULARIO -->
      <form
        *ngIf="selectedRecommendation"
        (ngSubmit)="submitFeedback()"
        class="space-y-3"
      >
        <!-- ¿Aplicaste la recomendación? -->
        <div class="space-y-1">
          <label class="text-xs font-semibold block">
            ¿Aplicaste la recomendación?
          </label>
          <div class="flex flex-wrap gap-3 text-[11px] text-text-muted">
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input
                type="radio"
                name="applied"
                class="h-3 w-3"
                [(ngModel)]="applied"
                [value]="'si'"
              />
              Sí
            </label>
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input
                type="radio"
                name="applied"
                class="h-3 w-3"
                [(ngModel)]="applied"
                [value]="'no'"
              />
              No
            </label>
          </div>
        </div>

        <!-- ¿Fue útil para prevenir molestias o lesiones? -->
        <div class="space-y-1">
          <label class="text-xs font-semibold block">
            ¿Qué tan útil fue para prevenir molestias o lesiones? (1–10)
          </label>
          <input
            type="range"
            min="1"
            max="10"
            [(ngModel)]="helpfulScore"
            name="helpfulScore"
            class="w-full"
          />
          <p class="text-[11px] text-text-muted">
            Valor actual:
            <span class="font-semibold text-text-main">{{ helpfulScore }}</span>
          </p>
        </div>

        <!-- Claridad de la explicación -->
        <div class="space-y-1">
          <label class="text-xs font-semibold block">
            ¿Qué tan clara fue la explicación? (1–10)
          </label>
          <input
            type="range"
            min="1"
            max="10"
            [(ngModel)]="clarityScore"
            name="clarityScore"
            class="w-full"
          />
          <p class="text-[11px] text-text-muted">
            Valor actual:
            <span class="font-semibold text-text-main">{{ clarityScore }}</span>
          </p>
        </div>

        <!-- Estrellas -->
        <div class="space-y-1">
          <label class="text-xs font-semibold block">
            Calificación general (1 a 5 estrellas)
          </label>
          <div class="flex items-center gap-1 text-xl">
            <button
              *ngFor="let s of starsArray"
              type="button"
              (click)="setStars(s)"
              class="focus:outline-none"
            >
              <span [ngClass]="s <= stars ? 'text-yellow-300' : 'text-slate-600'">
                ★
              </span>
            </button>
          </div>
        </div>

        <!-- Comentario -->
        <div class="space-y-1">
          <label class="text-xs font-semibold block">
            Comentario (opcional)
          </label>
          <textarea
            [(ngModel)]="comment"
            name="comment"
            rows="3"
            class="w-full rounded-xl border border-app-border bg-slate-950/60 px-3 py-2 text-xs outline-none focus:border-primary focus:ring-2 focus:ring-primary/40 resize-none"
            placeholder="Cuéntanos si hubo algo especialmente útil o algo que podríamos mejorar."
          ></textarea>
        </div>

        <!-- Botón centrado en móvil, alineado a la izq en desktop -->
        <div class="pt-2 flex justify-center md:justify-start">
          <button
            type="submit"
            [disabled]="loading"
            class="inline-flex items-center justify-center rounded-xl bg-primary px-4 py-2 text-xs font-semibold text-white shadow-lg shadow-primary/30 hover:bg-primary-dark transition disabled:opacity-60 disabled:cursor-not-allowed"
          >
            {{ loading ? 'Enviando...' : 'Enviar feedback' }}
          </button>
        </div>
      </form>

      <!-- Mensaje cuando no hay recomendación seleccionada -->
      <div *ngIf="!selectedRecommendation && !loading" class="text-xs text-text-muted">
        Primero selecciona una recomendación en la tarjeta de la izquierda para poder evaluarla.
      </div>
    </div>
  </div>
</div>